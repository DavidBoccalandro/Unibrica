<div class="dashboard-container" [formGroup]="dashboardForm">
  <h3>Efectividad de cobro</h3>
  <button mat-fab extended class="button-info" (click)="isInfoVisible = !isInfoVisible">
    <mat-icon>info</mat-icon>
    Información
  </button>
  <div class="info" *ngIf="isInfoVisible" [@shrinkOut]>
    <p>
      Este gráfico tiene como objetivo mostrar la eficiencia de recuperación de pagos de cada
      cliente, representando la relación entre montos cobrados, montos no cobrados y montos
      reversados. Estas tres categorías reflejan las diferentes fases del proceso de recuperación de
      la deuda, ofreciendo una visión clara de la situación financiera de cada cliente en cuanto a
      la cobranza.
    </p>
    <p>
      <strong>Ejes</strong>
    </p>
    <p>
      Eje X (horizontal) muestra los clientes. El eje Y (vertical) muestra los montos relacionados
      con los pagos, en función de las categorías "Monto cobrado", "Monto no cobrado" y "Monto
      reversado".
    </p>
    <p>
      La altura de la barra representa la deuda a total del mes, o sea, la sumatoria de todos los
      montos de las liquidaciones
    </p>
    <strong> Series de Datos: </strong>
    <p>
      Cada cliente tiene una barra apilada con tres componentes:
      <strong> Monto cobrado: </strong>
      La cantidad total de deuda cobrada por el cliente.
      <strong> Monto no cobrado: </strong>
      La deuda restante que aún no ha sido cobrada por el cliente.
      <strong> Monto reversado: </strong>
      Pagos que fueron reversados
    </p>
    <strong>Fechas de cómputo</strong>
    <p>
      Cada uno de los montos (deuda, pago o reversa) es computado según la fecha del archivo que
      creó el registro. Por ejemplo, si un archivo de liquidaciones tiene fecha de agosto, el
      registro se verá reflejado en el gráfico en agosto.
    </p>
  </div>
  <ng-container class="charts-container" formGroupName="stackedBarsChartForm">
    <div class="chart-wrapper">
      <div class="left-side">
        <div class="subtitle">
          <h4>Período:</h4>
          <div *ngIf="dashboardForm.get('stackedBarsChartForm.start')?.value; else noDate">
            <h4>
              {{ dashboardForm.get('stackedBarsChartForm.start')?.value | date : 'dd/MM/yyyy' }}
              hasta
              {{ dashboardForm.get('stackedBarsChartForm.end')?.value | date : 'dd/MM/yyyy' }}
            </h4>
          </div>
          <ng-template #noDate>
            <h4>{{getCurrentMonth()}}</h4>
          </ng-template>
        </div>
        <div class="controls">
          <mat-form-field appearance="outline">
            <mat-select placeholder="Clientes" formControlName="clientName" multiple>
              <mat-option *ngFor="let client of clients" [value]="client.name">{{
                client.name
              }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Rango de búsqueda</mat-label>
            <mat-date-range-input [rangePicker]="dateRangePicker">
              <input matStartDate placeholder="Fecha de inicio" formControlName="start" />
              <input matEndDate placeholder="Fecha de fin" formControlName="end" />
            </mat-date-range-input>
            <mat-datepicker-toggle matIconSuffix [for]="dateRangePicker"></mat-datepicker-toggle>
            <mat-date-range-picker #dateRangePicker></mat-date-range-picker>
          </mat-form-field>

          <button mat-raised-button color="primary" (click)="loadPaymentsForAllClients()">
            Actualizar
          </button>
        </div>
      </div>

      <!-- <app-line-chart [data]="lineChartData" [labels]="lineChartLabels" [view]="view"></app-line-chart> -->
      <div class="right-side">
        <ngx-charts-bar-vertical-stacked
          [view]="view"
          [scheme]="colorScheme"
          [results]="data"
          [gradient]="gradient"
          [xAxis]="showXAxis"
          [yAxis]="showYAxis"
          [legend]="showLegend"
          [showXAxisLabel]="showXAxisLabel"
          [showYAxisLabel]="showYAxisLabel"
          [xAxisLabel]="xAxisLabel"
          [yAxisLabel]="yAxisLabel"
          [animations]="animations"
          [yScaleMax]="maxValue"
          [barPadding]="60"
          [legendPosition]="legendPosition"
        >
        </ngx-charts-bar-vertical-stacked>
      </div>
      <div class="efficiency-cards" [ngClass]="{ 'small-cards': data.length > 3 }">
        <div
          *ngFor="let client of data"
          class="efficiency-card"
          [ngClass]="{ 'small-card': data.length > 3 }"
        >
          <h5>{{ client.name }}</h5>
          <div>
            <div class="card-content">
              <!-- Columna de la eficiencia -->
              <div class="efficiency-column">
                <div class="efficiency-container">
                  <p class="efficiency-label">Deuda total</p>
                  <p class="debt-value">{{ client.totalDebtSum }}</p>
                </div>
                <div class="efficiency-container">
                  <p class="efficiency-label">Eficacia de cobro</p>
                  <p class="efficiency-value">{{ client.collectionEfficiency }}%</p>
                </div>
              </div>

              <!-- Columna de los detalles -->
              <!-- <div class="details-column">
                <p>
                  <strong>Monto cobrado:</strong>
                  <span class="value">{{ client.totalDebitAmountSum | currency }}</span>
                </p>
                <p>
                  <strong>Monto de deuda restante:</strong>
                  <span class="value">{{ client.totalRemainingDebtSum | currency }}</span>
                </p>
              </div> -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>
